---
title: "COVID-19 en el PERU y el mundo"
author: "Javier Chang"
date: "`r format(Sys.time(), '%d/%m/%y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.width=12, fig.height=8)

## PREREQUISITES 
Sys.setlocale("LC_ALL","English")

if (!require("gridExtra")) {
        install.packages("gridExtra", dependencies = TRUE)
        library(gridExtra)
}
if (!require("ggplot2")) {
     install.packages("ggplot2", dependencies = TRUE)
     library(ggplot2)
}
if (!require("dplyr")) {
     install.packages("dplyr", dependencies = TRUE)
     library(dplyr)
}
if (!require("kableExtra")) {
   install.packages("kableExtra", dependencies = TRUE)
   library(kableExtra)
}
if (!require("ggdendro")) {
        install.packages("ggdendro", dependencies = TRUE)
        library(ggdendro)
}
if (!require("heatmaply")) {
        install.packages("heatmaply", dependencies = TRUE)
        library(heatmaply)
}
if (!require("corrplot")) {
        install.packages("corrplot", dependencies = TRUE)
        library(corrplot)
}
if (!require("RColorBrewer")) {
        install.packages("RColorBrewer", dependencies = TRUE)
        library(RColorBrewer)
}
```

## Sinopsis

El presente documento describe la evolución de COVID-19 en el Perú y la compara con otros paises, siendo que el Perú se encuentra en el top 10 a nivel mundial de casos confirmados y cantidad de fallecidos por COVID-19.

## Fuente de información

La fuente de información es el conjunto COVID-19 mantenido por Our World In Data. Esta fuente es actualizada diariamente e incluye datos sobre los casos confirmados, fallecidos y pruebas, así como otras variables de interés potencial.

El repositiorio de los datos se encuentra en GitHub [Data on COVID-19 (coronavirus) by Our World in Data](https://github.com/owid/covid-19-data/tree/master/public/data) y los datos COVID-19 son obtenidos desde el siguiente link: [Covid data](https://covid.ourworldindata.org/data/owid-covid-data.csv)

```{r load_data}

## Descarga datos de ourworldindata
dfile <- "owid-covid-data.csv"
if (!file.exists(dfile) | as.Date(file.mtime(dfile)) != Sys.Date()) {
     download.file("https://covid.ourworldindata.org/data/owid-covid-data.csv",
                   destfile = dfile)
}
covidtotal <- read.csv(dfile,
                  header = TRUE,
                  colClasses = c(date = "Date"))

## Totaliza datos por país
country.data <- covidtotal[covidtotal$total_cases>0 & covidtotal$iso_code!="" & covidtotal$iso_code!="OWID_WRL",] %>% 
        filter(!is.na(iso_code)) %>%
        group_by(iso_code, continent, location, population, population_density, median_age, aged_65_older,
                 aged_70_older, gdp_per_capita, extreme_poverty, cardiovasc_death_rate, diabetes_prevalence,
                 female_smokers, male_smokers, handwashing_facilities, hospital_beds_per_thousand, life_expectancy) %>% 
        summarise(date=min(date),
                  total_cases=max(total_cases, na.rm=TRUE), 
                  new_cases=mean(new_cases, na.rm=TRUE),
                  total_deaths=max(total_deaths, na.rm=TRUE),
                  new_deaths=mean(new_deaths, na.rm=TRUE),
                  total_cases_per_million=max(total_cases_per_million, na.rm=TRUE),
                  new_cases_per_million=mean(new_cases_per_million, na.rm=TRUE),
                  total_deaths_per_million=max(total_deaths_per_million, na.rm=TRUE),
                  new_deaths_per_million=mean(new_deaths_per_million, na.rm=TRUE),
                  total_tests=max(total_tests, na.rm=TRUE),
                  new_tests=mean(new_tests, na.rm=TRUE),
                  total_tests_per_thousand=max(total_tests_per_thousand, na.rm=TRUE),
                  new_tests_per_thousand=mean(new_tests_per_thousand, na.rm=TRUE),
                  stringency_index=mean(stringency_index, na.rm=TRUE)
                  ) %>%
        ungroup()
country.data$days_since_1st_case <- Sys.Date() - country.data$date
country.data$iso_code <- as.character(country.data$iso_code)

```


## Resultados

### Casos confirmados COVID-19 y fallecidos en el PERU

```{r peruresults}

## Parametros
country="PER"  ## PER Peru
hoy=unclass(Sys.Date())

## Subconjunto de datos de Peru
covid <- subset(covidtotal, iso_code == country & !is.na(total_cases))

## Calcula dias transcurridos
diastrans <- with(covid[covid$total_cases>0,], as.Date(hoy, origin="1970-01-01") - 
             as.Date(covid[which.min(total_cases),]$date, origin="1970-01-01"))

## Obtiene los casos de ayer y cuál es el percentil correspondiente
quantInv <- function(distr, value) ecdf(distr)(value)
yesterdaycases <- covid[which(covid$date==hoy),]$new_cases
totalcases <- covid[which(covid$date==hoy),]$total_cases
yesterdaydeaths <- covid[which(covid$date==hoy),]$new_deaths
totaldeaths <- covid[which(covid$date==hoy),]$total_deaths
percentilrank <- as.integer(quantInv(covid$new_cases, yesterdaycases)*100)

## Calcula dia de la semana
fechainicio <- unclass(as.Date("2020-03-15"))
covid$fecha <- unclass(covid$date)
covid$diasemana <- factor(weekdays(covid$date), c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"), ordered=TRUE)
percentilwod <- as.integer(quantInv(covid$new_cases[covid$diasemana==weekdays(as.Date(hoy, origin="1970-01-01"))], yesterdaycases)*100)
```

Han transcurrido **`r diastrans`** dias desde la aparicion del primer caso y ayer se confirmaron **`r format(yesterdaycases, big.mark=",")`** nuevos casos. Dicha cantidad esta en el **`r percentilrank`th** percentile de los nuevos casos confirmados diariamente y es el  **`r percentilwod`th** percentil de su correspondiente dia de la semana. A la fecha hemos acumulado un total de **`r format(totalcases, big.mark=",")`** casos confirmados.

Asimismo, ayer se registraron **`r format(yesterdaydeaths, big.mark=",")`** fallecimientos y el total acumulado de fallecidos es de  **`r format(totaldeaths, big.mark=",")`** personas.

A continuacion se muestra la evolucion de los nuevos casos confirmados y fallecidos.

```{r plotgraphs}

# Grafica New Cases
newcasestoday <- covid$new_cases[covid$fecha==hoy]
g1<-ggplot(covid[covid$new_cases>0,], aes(date, new_cases))+
        ggtitle(label=paste("New confirmed cases COVID-19",country))+
        theme(plot.title = element_text(hjust = 0.5))+
        geom_line()+
##        geom_line(data=futuro, colour="red")+
        geom_smooth()+
        geom_point(aes(x=as.Date(hoy, origin="1970-01-01"), y=newcasestoday), colour="red", size=2)

## Gráfica Total Cases
g2<-ggplot(covid, aes(date, total_cases))+
        ggtitle(paste("Total confirmed cases COVID-19",country))+
        theme(plot.title = element_text(hjust = 0.5))+
        geom_line()
##        geom_line(data=futuro, colour="red")

## Grafica nuevos casos por dia de la semana
g3<-ggplot(covid, aes(diasemana, new_cases))+
        ggtitle(paste("New confirmed cases by day of week",country))+
        xlab("dayofweek")+
        theme(plot.title = element_text(hjust = 0.5))+
        geom_boxplot()+
        geom_point(aes(x=weekdays(as.Date(hoy, origin="1970-01-01")), y=newcasestoday), colour="red", size=2)

## Grafica proporción de nuevos casos vs nuevos tests
g4 <- ggplot(covid, aes(date, stringency_index))+
        ggtitle(paste("Stringency index",country))+
        theme(plot.title = element_text(hjust = 0.5))+
        geom_line()

# Grafica New Deaths
newdeathstoday <- covid$new_deaths[covid$fecha==hoy]
g5<-ggplot(covid, aes(date, new_deaths))+
        ggtitle(label=paste("New deaths COVID-19",country))+
        theme(plot.title = element_text(hjust = 0.5))+
        geom_line()+
        geom_smooth()+
        ylim(0,250)+
        geom_point(aes(x=as.Date(hoy, origin="1970-01-01"), y=newdeathstoday), colour="red", size=2)

## Gráfica Total Cases
g6<-ggplot(covid, aes(date, total_deaths))+
        ggtitle(paste("Total deaths COVID-19",country))+
        theme(plot.title = element_text(hjust = 0.5))+
        geom_line()

grid.arrange(g1, g2, g4, g3, g5, g6, ncol=2, nrow=3)
```

### Ranking de nuevos casos COVID-19 confirmados por pais

A continuación se muestra el ranking de los 15 paises con mayor cantidad de casos confirmados de COVID-19.

```{r ranking_cases}

## Selecciona top 15
top15 <- country.data %>%
        arrange(desc(total_cases)) %>%
        top_n(15, total_cases)
top15 <- cbind(top15, rank=rownames(top15))

## Muestra tabla
knitr::kable(top15[,c("rank", "iso_code", "location", "total_cases_per_million", "total_cases")],
             format="html",
             digits=0,
             format.args = list(decimal.mark = ".", big.mark = ",")) %>%
   kable_styling(font_size = 10, full_width=TRUE)
```
\n
En el siguiente cuadro se muestra la evolucion de nuevos casos COVID-19 por millon de habitantes en cada uno de estos paises.

```{r newconfirmedcases}

## Select top 15 with more confirmed cases
covid <- subset(covidtotal, (iso_code %in% top15$iso_code) & total_cases>0)

## Plot the graph
ggplot(covid, aes(date, new_cases_per_million)) +
     ggtitle("New COVID-19 confirmed cases per millions by country")+
     theme(plot.title = element_text(hjust = 0.5))+
     geom_point(size=0.75) + 
     facet_wrap(~iso_code, ncol=3) +
     geom_smooth()+
     ylim(0,300)
```

### Ranking de fallecidos por COVID-19 por pais

A continuación se muestra el ranking de los 15 paises con mayor cantidad de fallecidos por COVID-19.

```{r ranking_deaths}
## Selecciona top 15
top15 <- country.data %>%
        arrange(desc(total_deaths)) %>%
        top_n(15, total_deaths)
top15 <- cbind(top15, rank=rownames(top15))

## Muestra tabla
knitr::kable(top15[,c("rank", "iso_code", "location", "total_deaths_per_million", "total_deaths")],
             format="html",
             format.args = list(decimal.mark = ".", big.mark = ","),
             digits=0) %>%
   kable_styling(font_size = 10, full_width=TRUE)
```

En el siguiente cuadro se muestra la evolucion de fallecidos COVID-19 por millon de habitantes por dia en cada uno de estos paises.

```{r new_deaths}
## Select top 15 with more total_deaths
covid <-
        subset(covidtotal, (iso_code %in% top15$iso_code) & total_cases > 0)

## Plot the graph
ggplot(covid, aes(date, new_deaths_per_million)) +
     ggtitle("New COVID-19 deaths per millions by country")+
     theme(plot.title = element_text(hjust = 0.5))+
     geom_line() + 
     facet_wrap(~iso_code, ncol=3) +
     ylim(0,30)
```

### Variables relacionadas con el total de casos confirmados y fallecidos por millon por COVID-19

Realizamos un análisis de cluster de las variables y obtenemos el siguiente dendrograma.

```{r dendrogram_variables}
## Selecciona variables para el dendrograma
cd <- country.data %>% 
        select(1:17,
               stringency_index,
               total_deaths_per_million,
               total_cases_per_million,
               -population,
               -gdp_per_capita,
               -continent,
               -location) %>% 
        mutate_all(~ifelse(is.infinite(.x), NA, .x)) %>%
        mutate_all(~ifelse(is.na(.x), mean(.x, na.rm = TRUE), .x))
rownames(cd) <- cd$iso_code
cd <- select(cd, -iso_code) 

## Calculate the cluster
hc <- hclust(dist(scale(t(cd))))

## convert cluster object to use with ggplot
dendr <- dendro_data(hc, type="rectangle") 

## Plot the dendrogram
ggplot() + 
        geom_segment(data=segment(dendr), aes(x=x, y=y, xend=xend, yend=yend)) + 
        geom_text(data=label(dendr), aes(x=x, y=y, label=label, hjust=0), size=3) +
        coord_flip() + scale_y_reverse(expand=c(0.2, 0)) + 
        theme(axis.line.y=element_blank(),
              axis.ticks.y=element_blank(),
              axis.text.y=element_blank(),
              axis.title.y=element_blank(),
              panel.background=element_rect(fill="white"),
              panel.grid=element_blank())+
     ggtitle("Similarity dendrogram of variables")+
     theme(plot.title = element_text(hjust = 0.5))
```

Por lo que podemos observar que el total de fallecidos por millon tiene mayor cercanía con dos grupos de variables:

* Pobreza extrema, mayor edad de la población, fumadoras mujeres, camas de hospital por millón de habitantes y prevalencia de diabetes
* Expectativa de vida, qué tan restrictivas han sido las medidas del gobierno, facilidades para lavarse las manos y fumadores hombres

Y la correlacion entre las variables es la siguiente:

```{r corr_todo}
## Correlaciona variables
M <- cor(cd)
corrplot(M, type="upper", order="hclust",
         col=brewer.pal(n=8, name="RdYlBu"))
```

### Similitud entre los países con población mayor a 30 millones de habitantes

Asimismo, podemos realizar un análisis de cluster por países para observar la similitud entre ellos. El Peru se parece más a Iran, Mexico, Brasil y Colombia.

```{r dendro_pais}

## Selecciona paises con poblacion mayor de 30 millones de habitantes
cd <- country.data %>% 
        filter(population>30000000) %>%
        select(1:17,
               stringency_index,
               total_deaths_per_million, 
               -population,
               -gdp_per_capita,
               -continent,
               -location) %>% 
        mutate_all(~ifelse(is.infinite(.x), NA, .x)) %>%
        mutate_all(~ifelse(is.na(.x), mean(.x, na.rm = TRUE), .x))
rownames(cd) <- cd$iso_code
cd <- select(cd, -iso_code) 

## Calculate the cluster
hc <- hclust(dist(scale(cd)))

## convert cluster object to use with ggplot
dendr <- dendro_data(hc, type="rectangle") 

## Plot the dendrogram
ggplot() + 
        geom_segment(data=segment(dendr), aes(x=x, y=y, xend=xend, yend=yend)) + 
        geom_text(data=label(dendr), aes(x=x, y=y, label=label, hjust=0), size=3) +
        coord_flip() + scale_y_reverse(expand=c(0.2, 0)) + 
        theme(axis.line.y=element_blank(),
              axis.ticks.y=element_blank(),
              axis.text.y=element_blank(),
              axis.title.y=element_blank(),
              panel.background=element_rect(fill="white"),
              panel.grid=element_blank())+
     ggtitle("Similarity dendrogram of variables")+
     theme(plot.title = element_text(hjust = 0.5))

```

Por otro lado, podemos observar en el *heatmap* de los países con población mayor a 30 millones, la relación entre los fallecidos por COVID-19 y el resto de variables.

```{r heatmap}
ggheatmap(scale(cd), colors=heat.colors(10), k_col=4, k_row=5)
```

Y entre estos países la correlación entre las variables es como se muestra a continuación.

```{r correlacion}
M <- cor(cd)
corrplot(M, type="upper", order="hclust",
         col=brewer.pal(n=8, name="RdYlBu"))
```

